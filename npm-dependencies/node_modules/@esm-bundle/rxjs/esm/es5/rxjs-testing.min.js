/* rxjs@6.6.3 */
import{_ as e,S as r,O as s}from"./rxjs-shared.min.js";import{S as t,N as a,a as i}from"./rxjs-shared.min3.js";import"./rxjs-shared.min8.js";import{V as n,a as o}from"./rxjs-shared.min5.js";var c=function(){return function(e,r){void 0===r&&(r=Number.POSITIVE_INFINITY),this.subscribedFrame=e,this.unsubscribedFrame=r}}(),u=function(s){function t(e,t){var a=s.call(this,(function(e){var s=this,t=s.logSubscribedFrame(),a=new r;return a.add(new r((function(){s.logUnsubscribedFrame(t)}))),s.scheduleMessages(e),a}))||this;return a.messages=e,a.subscriptions=[],a.scheduler=t,a}return e(t,s),t.prototype.scheduleMessages=function(e){for(var r=this.messages.length,s=0;s<r;s++){var t=this.messages[s];e.add(this.scheduler.schedule((function(e){var r=e.message,s=e.subscriber;r.notification.observe(s)}),t.frame,{message:t,subscriber:e}))}},t}(s),b=function(s){function t(e,r){var t=s.call(this)||this;return t.messages=e,t.subscriptions=[],t.scheduler=r,t}return e(t,s),t.prototype._subscribe=function(e){var t=this,a=t.logSubscribedFrame(),i=new r;return i.add(new r((function(){t.logUnsubscribedFrame(a)}))),i.add(s.prototype._subscribe.call(this,e)),i},t.prototype.setup=function(){for(var e=this,r=e.messages.length,s=0;s<r;s++)!function(){var r=e.messages[s];e.scheduler.schedule((function(){r.notification.observe(e)}),r.frame)}()},t}(t),f=function(r){function t(e){var s=r.call(this,o,750)||this;return s.assertDeepEqual=e,s.hotObservables=[],s.coldObservables=[],s.flushTests=[],s.runMode=!1,s}return e(t,r),t.prototype.createTime=function(e){var r=e.indexOf("|");if(-1===r)throw new Error('marble diagram for time should have a completion marker "|"');return r*t.frameTimeFactor},t.prototype.createColdObservable=function(e,r,s){if(-1!==e.indexOf("^"))throw new Error('cold observable cannot have subscription offset "^"');if(-1!==e.indexOf("!"))throw new Error('cold observable cannot have unsubscription marker "!"');var a=t.parseMarbles(e,r,s,void 0,this.runMode),i=new u(a,this);return this.coldObservables.push(i),i},t.prototype.createHotObservable=function(e,r,s){if(-1!==e.indexOf("!"))throw new Error('hot observable cannot have unsubscription marker "!"');var a=t.parseMarbles(e,r,s,void 0,this.runMode),i=new b(a,this);return this.hotObservables.push(i),i},t.prototype.materializeInnerObservable=function(e,r){var s=this,t=[];return e.subscribe((function(e){t.push({frame:s.frame-r,notification:a.createNext(e)})}),(function(e){t.push({frame:s.frame-r,notification:a.createError(e)})}),(function(){t.push({frame:s.frame-r,notification:a.createComplete()})})),t},t.prototype.expectObservable=function(e,r){var i=this;void 0===r&&(r=null);var n,o=[],c={actual:o,ready:!1},u=t.parseMarblesAsSubscriptions(r,this.runMode),b=u.subscribedFrame===Number.POSITIVE_INFINITY?0:u.subscribedFrame,f=u.unsubscribedFrame;this.schedule((function(){n=e.subscribe((function(e){var r=e;e instanceof s&&(r=i.materializeInnerObservable(r,i.frame)),o.push({frame:i.frame,notification:a.createNext(r)})}),(function(e){o.push({frame:i.frame,notification:a.createError(e)})}),(function(){o.push({frame:i.frame,notification:a.createComplete()})}))}),b),f!==Number.POSITIVE_INFINITY&&this.schedule((function(){return n.unsubscribe()}),f),this.flushTests.push(c);var h=this.runMode;return{toBe:function(e,r,s){c.ready=!0,c.expected=t.parseMarbles(e,r,s,!0,h)}}},t.prototype.expectSubscriptions=function(e){var r={actual:e,ready:!1};this.flushTests.push(r);var s=this.runMode;return{toBe:function(e){var a="string"==typeof e?[e]:e;r.ready=!0,r.expected=a.map((function(e){return t.parseMarblesAsSubscriptions(e,s)}))}}},t.prototype.flush=function(){for(var e=this,s=this.hotObservables;s.length>0;)s.shift().setup();r.prototype.flush.call(this),this.flushTests=this.flushTests.filter((function(r){return!r.ready||(e.assertDeepEqual(r.actual,r.expected),!1)}))},t.parseMarblesAsSubscriptions=function(e,r){var s=this;if(void 0===r&&(r=!1),"string"!=typeof e)return new c(Number.POSITIVE_INFINITY);for(var t,a=e.length,i=-1,n=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,u=0,b=function(a){var c=u,b=function(e){c+=e*s.frameTimeFactor},h=e[a];switch(h){case" ":r||b(1);break;case"-":b(1);break;case"(":i=u,b(1);break;case")":i=-1,b(1);break;case"^":if(n!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");n=i>-1?i:u,b(1);break;case"!":if(o!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");o=i>-1?i:u;break;default:if(r&&h.match(/^[0-9]$/)&&(0===a||" "===e[a-1])){var m=e.slice(a).match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(m){a+=m[0].length-1;var l=parseFloat(m[1]),d=void 0;switch(m[2]){case"ms":d=l;break;case"s":d=1e3*l;break;case"m":d=1e3*l*60}b(d/f.frameTimeFactor);break}}throw new Error("there can only be '^' and '!' markers in a subscription marble diagram. Found instead '"+h+"'.")}u=c,t=a},f=this,h=0;h<a;h++)b(h),h=t;return o<0?new c(n):new c(n,o)},t.parseMarbles=function(e,r,s,t,i){var n=this;if(void 0===t&&(t=!1),void 0===i&&(i=!1),-1!==e.indexOf("!"))throw new Error('conventional marble diagrams cannot have the unsubscription marker "!"');for(var o,c=e.length,b=[],f=i?e.replace(/^[ ]+/,"").indexOf("^"):e.indexOf("^"),h=-1===f?0:f*-this.frameTimeFactor,m="object"!=typeof r?function(e){return e}:function(e){return t&&r[e]instanceof u?r[e].messages:r[e]},l=-1,d=function(r){var t=h,c=function(e){t+=e*n.frameTimeFactor},u=void 0,f=e[r];switch(f){case" ":i||c(1);break;case"-":c(1);break;case"(":l=h,c(1);break;case")":l=-1,c(1);break;case"|":u=a.createComplete(),c(1);break;case"^":c(1);break;case"#":u=a.createError(s||"error"),c(1);break;default:if(i&&f.match(/^[0-9]$/)&&(0===r||" "===e[r-1])){var d=e.slice(r).match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(d){r+=d[0].length-1;var v=parseFloat(d[1]),I=void 0;switch(d[2]){case"ms":I=v;break;case"s":I=1e3*v;break;case"m":I=1e3*v*60}c(I/p.frameTimeFactor);break}}u=a.createNext(m(f)),c(1)}u&&b.push({frame:l>-1?l:h,notification:u}),h=t,o=r},p=this,v=0;v<c;v++)d(v),v=o;return b},t.prototype.run=function(e){var r=t.frameTimeFactor,s=this.maxFrames;t.frameTimeFactor=1,this.maxFrames=Number.POSITIVE_INFINITY,this.runMode=!0,i.delegate=this;var a={cold:this.createColdObservable.bind(this),hot:this.createHotObservable.bind(this),flush:this.flush.bind(this),expectObservable:this.expectObservable.bind(this),expectSubscriptions:this.expectSubscriptions.bind(this)};try{var n=e(a);return this.flush(),n}finally{t.frameTimeFactor=r,this.maxFrames=s,this.runMode=!1,i.delegate=void 0}},t}(n);export{f as TestScheduler};
