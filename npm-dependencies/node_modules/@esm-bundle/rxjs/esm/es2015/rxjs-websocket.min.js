/* rxjs@6.6.3 */
import{O as t,e,S as s}from"./rxjs-shared.min.js";import{h as r,S as o}from"./rxjs-shared.min3.js";import{R as n}from"./rxjs-shared.min4.js";import"./rxjs-shared.min8.js";const i={url:"",deserializer:t=>JSON.parse(t.data),serializer:t=>JSON.stringify(t)};class c extends r{constructor(e,s){if(super(),e instanceof t)this.destination=s,this.source=e;else{const t=this._config=Object.assign({},i);if(this._output=new o,"string"==typeof e)t.url=e;else for(let s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);if(!t.WebSocketCtor&&WebSocket)t.WebSocketCtor=WebSocket;else if(!t.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new n}}lift(t){const e=new c(this._config,this.destination);return e.operator=t,e.source=this,e}_resetState(){this._socket=null,this.source||(this.destination=new n),this._output=new o}multiplex(e,s,r){const o=this;return new t(t=>{try{o.next(e())}catch(e){t.error(e)}const n=o.subscribe(e=>{try{r(e)&&t.next(e)}catch(e){t.error(e)}},e=>t.error(e),()=>t.complete());return()=>{try{o.next(s())}catch(e){t.error(e)}n.unsubscribe()}})}_connectSocket(){const{WebSocketCtor:t,protocol:r,url:o,binaryType:i}=this._config,c=this._output;let a=null;try{a=r?new t(o,r):new t(o),this._socket=a,i&&(this._socket.binaryType=i)}catch(t){return void c.error(t)}const h=new s(()=>{this._socket=null,a&&1===a.readyState&&a.close()});a.onopen=t=>{const{_socket:s}=this;if(!s)return a.close(),void this._resetState();const{openObserver:r}=this._config;r&&r.next(t);const o=this.destination;this.destination=e.create(t=>{if(1===a.readyState)try{const{serializer:e}=this._config;a.send(e(t))}catch(t){this.destination.error(t)}},t=>{const{closingObserver:e}=this._config;e&&e.next(void 0),t&&t.code?a.close(t.code,t.reason):c.error(new TypeError("WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }")),this._resetState()},()=>{const{closingObserver:t}=this._config;t&&t.next(void 0),a.close(),this._resetState()}),o&&o instanceof n&&h.add(o.subscribe(this.destination))},a.onerror=t=>{this._resetState(),c.error(t)},a.onclose=t=>{this._resetState();const{closeObserver:e}=this._config;e&&e.next(t),t.wasClean?c.complete():c.error(t)},a.onmessage=t=>{try{const{deserializer:e}=this._config;c.next(e(t))}catch(t){c.error(t)}}}_subscribe(t){const{source:e}=this;return e?e.subscribe(t):(this._socket||this._connectSocket(),this._output.subscribe(t),t.add(()=>{const{_socket:t}=this;0===this._output.observers.length&&(t&&1===t.readyState&&t.close(),this._resetState())}),t)}unsubscribe(){const{_socket:t}=this;t&&1===t.readyState&&t.close(),this._resetState(),super.unsubscribe()}}function a(t){return new c(t)}export{c as WebSocketSubject,a as webSocket};
